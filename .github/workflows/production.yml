name: Production Environment CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''

env:
  AZURE_WEBAPP_FRONTEND_NAME: appointment-booking-frontend
  AZURE_WEBAPP_BACKEND_NAME: appointment-booking-api
  NODE_VERSION: '20.x'
  DOTNET_VERSION: '10.0.x'

jobs:
  # Validation
  validate-deployment:
    name: ğŸ” Validate Deployment Request
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Confirm Production Deployment
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirm != 'deploy'
        run: |
          echo "âŒ Production deployment not confirmed"
          echo "Please type 'deploy' in the confirmation input"
          exit 1

  # Frontend Build and Deploy
  frontend-production:
    name: Frontend - Build & Deploy (Production)
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: always() && (needs.validate-deployment.result == 'success' || github.event_name == 'push')
    environment:
      name: production
      url: ${{ steps.deploy-frontend.outputs.webapp-url }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests
        run: npm test -- --run

      - name: ğŸ” Lint Check
        run: npm run lint || echo "Lint check skipped"

      - name: ğŸ”¨ Build Angular App (Production)
        run: npm run build -- --configuration=production
        env:
          NODE_ENV: production

      - name: ğŸ” Build Size Analysis
        run: |
          echo "ğŸ“Š Build Size Report:"
          du -sh dist/hcl2/browser
          ls -lh dist/hcl2/browser

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-production
          path: dist/hcl2/browser
          retention-days: 90

      - name: ğŸš€ Deploy to Azure Static Web Apps
        id: deploy-frontend
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist/hcl2/browser"
          skip_app_build: true

  # Backend Build and Deploy
  backend-production:
    name: Backend - Build & Deploy (Production)
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: always() && (needs.validate-deployment.result == 'success' || github.event_name == 'push')
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Restore Dependencies
        run: dotnet restore ./backend/AppointmentAPI.csproj

      - name: ğŸ”¨ Build (Production)
        run: dotnet build ./backend/AppointmentAPI.csproj --configuration Release --no-restore

      - name: ğŸ§ª Run Tests
        run: dotnet test ./backend/AppointmentAPI.csproj --no-restore --verbosity normal --configuration Release

      - name: ğŸ“¤ Publish
        run: dotnet publish ./backend/AppointmentAPI.csproj -c Release -o ./publish

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-production
          path: ./publish
          retention-days: 90

      - name: ğŸš€ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_BACKEND_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PROD }}
          package: ./publish

      - name: ğŸ—„ï¸ Run Database Migrations
        run: |
          echo "Running production database migrations..."
          # Add your production migration commands here
          # dotnet ef database update --project ./backend/AppointmentAPI.csproj

  # Integration Tests
  integration-tests:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend-production, backend-production]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â³ Wait for Deployment Propagation
        run: sleep 30

      - name: ğŸ” Health Check - Frontend
        run: |
          echo "Checking frontend health..."
          curl -f https://${{ env.AZURE_WEBAPP_FRONTEND_NAME }}.azurestaticapps.net || exit 1

      - name: ğŸ” Health Check - Backend API
        run: |
          echo "Checking backend health..."
          curl -f https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net/api/providers || exit 1

      - name: ğŸ” Health Check - Swagger
        run: |
          echo "Checking Swagger UI..."
          curl -f https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net || exit 1

      - name: ğŸ“Š Performance Check
        run: |
          echo "Running basic performance checks..."
          time curl -s https://${{ env.AZURE_WEBAPP_FRONTEND_NAME }}.azurestaticapps.net > /dev/null
          time curl -s https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net/api/providers > /dev/null

      - name: âœ… All Tests Passed
        run: echo "âœ… All integration tests passed successfully!"

  # Notification and Rollback
  notify-and-verify:
    name: ğŸ“¢ Notify and Verify
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always()
    
    steps:
      - name: âœ… Production Deployment Successful
        if: needs.integration-tests.result == 'success'
        run: |
          echo "ğŸ‰ Production deployment successful!"
          echo ""
          echo "ğŸŒ Live URLs:"
          echo "Frontend: https://${{ env.AZURE_WEBAPP_FRONTEND_NAME }}.azurestaticapps.net"
          echo "Backend API: https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net/api"
          echo "Swagger UI: https://${{ env.AZURE_WEBAPP_BACKEND_NAME }}.azurewebsites.net"
          echo ""
          echo "ğŸ“Š Deployment Info:"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"

      - name: âŒ Deployment Failed
        if: needs.integration-tests.result != 'success'
        run: |
          echo "âŒ Production deployment failed!"
          echo "Please check the logs and consider rolling back."
          exit 1

  # Create Release Tag
  create-release:
    name: ğŸ·ï¸ Create Release Tag
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: success() && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Create Release Tag
        run: |
          TAG_NAME="v1.0.${GITHUB_RUN_NUMBER}"
          echo "Creating release tag: $TAG_NAME"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a $TAG_NAME -m "Production Release $TAG_NAME"
          git push origin $TAG_NAME || echo "Tag push skipped"
